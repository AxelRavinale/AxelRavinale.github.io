{% extends 'base.html' %}
{% load static %}
{% load i18n %}


{% load regex_filters %}

{% block title %}Seleccionar Asientos - {{ vuelo.codigo_vuelo }}{% endblock %}

{% block content %}
<div class="fondo-transparente">
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <h1>üé´ Seleccionar Asientos</h1>
      <div class="alert alert-info">
        <strong>Vuelo:</strong> {{ vuelo.codigo_vuelo }} - {{ vuelo.origen_principal }} ‚Üí {{ vuelo.destino_principal }}<br>
        <strong>Fecha:</strong> {{ vuelo.fecha_salida_estimada|date:"d/m/Y H:i" }}
      </div>
    </div>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <form method="post" id="seleccionForm">
    {% csrf_token %}
    
    <!-- Filtros por tipo -->
    {% if form.filtro_tipo.field.choices %}
    <div class="card mb-4">
      <div class="card-body">
        <h6>üîç Filtrar por tipo de asiento:</h6>
        <div class="row">
          {% for choice in form.filtro_tipo %}
            <div class="col-md-3 col-sm-6 mb-2">
              <div class="form-check">
                {{ choice.tag }}
                <label for="{{ choice.id_for_label }}" class="form-check-label ms-2">
                  {{ choice.choice_label }}
                </label>
              </div>
            </div>
          {% endfor %}
        </div>
        <div class="mt-3">
          <button type="submit" name="accion" value="filtrar" class="btn btn-primary">
            üîç Aplicar Filtros
          </button>
          {% if filtros_aplicados %}
          <a href="{% url 'reservas:seleccion_asientos' vuelo.pk %}" class="btn btn-outline-secondary">
            üóëÔ∏è Limpiar Filtros
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Lista de asientos disponibles -->
    <div class="card mb-4">
      <div class="card-header">
        <h5>‚úàÔ∏è Asientos Disponibles</h5>
        {% if filtros_aplicados %}
          <small class="text-muted">
            Filtrado por: 
            {% for filtro in filtros_aplicados %}
              <span class="badge bg-info">{{ filtro }}</span>
            {% endfor %}
          </small>
        {% endif %}
      </div>
      <div class="card-body">
        {% if form.asientos_seleccionados.field.choices %}
          <div class="row">
            {% for choice in form.asientos_seleccionados %}
              <div class="col-md-6 col-lg-4 mb-3">
                <div class="card asiento-card h-100" 
                     data-asiento-id="{{ choice.choice_value }}"
                     data-numero="{{ choice.choice_label|extract_seat_number }}">
                  <div class="card-body p-3">
                    <div class="form-check">
                      {{ choice.tag }}
                      <label for="{{ choice.id_for_label }}" class="form-check-label ms-2">
                        <div class="fw-bold">{{ choice.choice_label }}</div>
                        <div class="small text-success mt-1">
                          ‚úÖ Disponible para selecci√≥n
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center text-muted py-5">
            <i class="fas fa-chair fa-3x mb-3"></i>
            <h5>No hay asientos disponibles</h5>
            <p>No se encontraron asientos con los filtros aplicados.</p>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Resumen de selecci√≥n -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h6>Asientos seleccionados: 
              <span class="badge bg-primary" id="contador-asientos">0</span>
            </h6>
            <div id="resumen-asientos" class="mb-2"></div>
          </div>
          <div class="col-md-6 text-end">
            <button type="submit" name="accion" value="continuar" 
                    class="btn btn-success btn-lg" id="btn-continuar" >
              ‚ö†Ô∏è Seleccione al menos un asiento
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Informaci√≥n adicional -->
    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h6>‚ÑπÔ∏è Informaci√≥n</h6>
            <ul class="small mb-0">
              <li>Una vez seleccionados, los asientos quedan reservados temporalmente</li>
              <li>Puede modificar su selecci√≥n antes de continuar</li>
              <li>El precio total se calcular√° en el siguiente paso</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h6>üé® Leyenda</h6>
            <div class="small">
              <div class="mb-1">
                <span class="badge bg-success">‚úÖ</span> Disponible para selecci√≥n
              </div>
              <div class="mb-1">
                <span class="badge bg-danger">‚ùå</span> Ocupado
              </div>
              <div class="mb-1">
                <span class="badge bg-warning">‚ö†</span> No disponible para reserva
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- Bot√≥n para volver -->
  <div class="mt-4 text-center">
    <a href="{% url 'reservas:vuelos_disponibles' %}" class="btn btn-outline-primary">
      ‚¨ÖÔ∏è Volver a Vuelos Disponibles
    </a>
  </div>
</div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.asiento-card {
  border: 2px solid #dee2e6;
  transition: all 0.2s ease;
  cursor: pointer;
}

.asiento-card:hover {
  border-color: #0d6efd;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.asiento-card:has(.form-check-input:checked) {
  border-color: #198754 !important;
  background-color: #d1e7dd;
  box-shadow: 0 4px 8px rgba(25, 135, 84, 0.15);
}

.form-check-input {
  transform: scale(1.2);
}

.form-check-label {
  cursor: pointer;
  width: 100%;
}

@media (max-width: 768px) {
  .btn-lg {
    width: 100%;
    margin-top: 1rem;
  }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const asientoCheckboxes = document.querySelectorAll('input[name="asientos_seleccionados"]');
    const contadorSpan = document.getElementById('contador-asientos');
    const resumenDiv = document.getElementById('resumen-asientos');
    const btnContinuar = document.getElementById('btn-continuar');
    
    // Hacer cards clickeables
    document.querySelectorAll('.asiento-card').forEach(card => {
        card.addEventListener('click', function(e) {
            if (e.target.type !== 'checkbox') {
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    actualizarResumen();
                }
            }
        });
    });
    
    // Actualizar cuando cambien los checkboxes
    asientoCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', actualizarResumen);
    });
    
    function actualizarResumen() {
        const seleccionados = Array.from(asientoCheckboxes).filter(cb => cb.checked);
        const cantidad = seleccionados.length;
        
        // Actualizar contador
        contadorSpan.textContent = cantidad;
        
        // Generar badges con n√∫meros de asientos
        let badges = '';
        seleccionados.forEach(checkbox => {
            const card = checkbox.closest('.asiento-card');
            const numero = card.getAttribute('data-numero') || 'N/A';
            badges += `<span class="badge bg-success me-1">${numero}</span>`;
        });
        
        // Actualizar UI
        resumenDiv.innerHTML = badges;
        
        // Actualizar bot√≥n
        if (cantidad > 0) {
            btnContinuar.disabled = false;
            btnContinuar.className = 'btn btn-success btn-lg';
            btnContinuar.innerHTML = `‚û°Ô∏è Continuar con ${cantidad} asiento${cantidad > 1 ? 's' : ''}`;
        } else {
            btnContinuar.disabled = true;
            btnContinuar.className = 'btn btn-secondary btn-lg';
            btnContinuar.innerHTML = '‚ö†Ô∏è Seleccione al menos un asiento';
        }
    }
    
    // Auto-submit filtros
    document.querySelectorAll('input[name="filtro_tipo"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            setTimeout(() => {
                const filtrarBtn = document.querySelector('button[value="filtrar"]');
                if (filtrarBtn) {
                    filtrarBtn.click();
                }
            }, 100);
        });
    });
    
    // Inicializar
    actualizarResumen();
    
    // Debug: Mostrar informaci√≥n de asientos
    console.log('Asientos disponibles:', asientoCheckboxes.length);
    asientoCheckboxes.forEach((checkbox, index) => {
        const card = checkbox.closest('.asiento-card');
        const numero = card.getAttribute('data-numero');
        console.log(`Asiento ${index + 1}: ${numero}`);
    });
});
</script>
{% endblock %}
